import{aR as x,b as p,aA as k,p as M,aN as S,J as b,e as N,at as l,D as C,aL as g,aK as R,aF as u,aS as F,aT as I,ag as P,aO as _,aG as E,aP as $,aQ as q,z as H}from"./vidstack-player-MMEUbwXI.js";import{VideoProvider as O}from"./vidstack-video-CmM1cGTv.js";import{R as j}from"./vidstack-DqAw8m9J-CCN-kYkS.js";import"./app-BySc-1W5.js";import"./vidstack-Bq6c3Bam-BCv6L9vw.js";function v(a){try{return new Intl.DisplayNames(navigator.languages,{type:"language"}).of(a)??null}catch{return null}}const Q=a=>`dash-${C(a)}`;class G{#e;#i;#t=null;#n=new Set;#r=null;config={};get instance(){return this.#t}constructor(t,i){this.#e=t,this.#i=i}setup(t){this.#t=t().create();const i=this.#g.bind(this);for(const s of Object.values(t.events))this.#t.on(s,i);this.#t.on(t.events.ERROR,this.#v.bind(this));for(const s of this.#n)s(this.#t);this.#i.player.dispatch("dash-instance",{detail:this.#t}),this.#t.initialize(this.#e,void 0,!1),this.#t.updateSettings({streaming:{text:{defaultEnabled:!1,dispatchForManualRendering:!0},buffer:{fastSwitchEnabled:!0}},...this.config}),this.#t.on(t.events.FRAGMENT_LOADING_STARTED,this.#w.bind(this)),this.#t.on(t.events.FRAGMENT_LOADING_COMPLETED,this.#E.bind(this)),this.#t.on(t.events.MANIFEST_LOADED,this.#b.bind(this)),this.#t.on(t.events.QUALITY_CHANGE_RENDERED,this.#S.bind(this)),this.#t.on(t.events.TEXT_TRACKS_ADDED,this.#m.bind(this)),this.#t.on(t.events.TRACK_CHANGE_RENDERED,this.#T.bind(this)),this.#i.qualities[S.enableAuto]=this.#A.bind(this),b(this.#i.qualities,"change",this.#D.bind(this)),b(this.#i.audioTracks,"change",this.#x.bind(this)),this.#r=N(this.#d.bind(this))}#s(t){return new l(Q(t.type),{detail:t})}#d(){if(!this.#i.$state.live())return;const t=new j(this.#f.bind(this));return t.start(),t.stop.bind(t)}#f(){if(!this.#t)return;const t=this.#t.duration()-this.#t.time();this.#i.$state.liveSyncPosition.set(isNaN(t)?1/0:t)}#g(t){this.#i.player?.dispatch(this.#s(t))}#a=null;#h={};#y(t){const i=this.#a?.[g.native],s=(i?.track).cues;if(!i||!s)return;const r=this.#a.id,n=this.#h[r]??0,o=this.#s(t);for(let c=n;c<s.length;c++){const h=s[c];h.positionAlign||(h.positionAlign="auto"),this.#a.addCue(h,o)}this.#h[r]=s.length}#m(t){if(!this.#t)return;const i=t.tracks,s=[...this.#e.textTracks].filter(n=>"manualMode"in n),r=this.#s(t);for(let n=0;n<s.length;n++){const o=i[n],c=s[n],h=`dash-${o.kind}-${n}`,d=new R({id:h,label:o?.label??o.labels.find(y=>y.text)?.text??(o?.lang&&v(o.lang))??o?.lang??void 0,language:o.lang??void 0,kind:o.kind,default:o.defaultTrack});d[g.native]={managed:!0,track:c},d[g.readyState]=2,d[g.onModeChange]=()=>{this.#t&&(d.mode==="showing"?(this.#t.setTextTrack(n),this.#a=d):(this.#t.setTextTrack(-1),this.#a=null))},this.#i.textTracks.add(d,r)}}#T(t){const{mediaType:i,newMediaInfo:s}=t;if(i==="audio"){const r=this.#i.audioTracks.getById(`dash-audio-${s.index}`);if(r){const n=this.#s(t);this.#i.audioTracks[u.select](r,!0,n)}}}#S(t){if(t.mediaType!=="video")return;const i=this.#i.qualities[t.newQuality];if(i){const s=this.#s(t);this.#i.qualities[u.select](i,!0,s)}}#b(t){if(this.#i.$state.canPlay()||!this.#t)return;const{type:i,mediaPresentationDuration:s}=t.data,r=this.#s(t);this.#i.notify("stream-type-change",i!=="static"?"live":"on-demand",r),this.#i.notify("duration-change",s,r),this.#i.qualities[S.setAuto](!0,r);const n=this.#t.getVideoElement(),o=this.#t.getTracksForTypeFromManifest("video",t.data),c=[...new Set(o.map(e=>e.mimeType))].find(e=>e&&F(n,e)),h=o.filter(e=>c===e.mimeType)[0];let d=this.#t.getTracksForTypeFromManifest("audio",t.data);const y=[...new Set(d.map(e=>e.mimeType))].find(e=>e&&I(n,e));if(d=d.filter(e=>y===e.mimeType),h.bitrateList.forEach((e,f)=>{const m={id:e.id?.toString()??`dash-bitrate-${f}`,width:e.width??0,height:e.height??0,bitrate:e.bandwidth??0,codec:h.codec,index:f};this.#i.qualities[u.add](m,r)}),P(h.index)){const e=this.#i.qualities[h.index];e&&this.#i.qualities[u.select](e,!0,r)}d.forEach((e,f)=>{const L=e.labels.find(T=>navigator.languages.some(D=>T.lang&&D.toLowerCase().startsWith(T.lang.toLowerCase())))||e.labels[0],A={id:`dash-audio-${e?.index}`,label:L?.text??(e.lang&&v(e.lang))??e.lang??"",language:e.lang??"",kind:"main",mimeType:e.mimeType,codec:e.codec,index:f};this.#i.audioTracks[u.add](A,r)}),n.dispatchEvent(new l("canplay",{trigger:r}))}#v(t){const{type:i,error:s}=t;switch(s.code){case 27:this.#L(s);break;default:this.#l(s);break}}#w(){this.#o>=0&&this.#c()}#E(t){t.mediaType==="text"&&requestAnimationFrame(this.#y.bind(this,t))}#o=-1;#L(t){this.#c(),this.#t?.play(),this.#o=window.setTimeout(()=>{this.#o=-1,this.#l(t)},5e3)}#c(){clearTimeout(this.#o),this.#o=-1}#l(t){this.#i.notify("error",{message:t.message??"",code:1,error:t})}#A(){this.#u("video",!0);const{qualities:t}=this.#i;this.#t?.setQualityFor("video",t.selectedIndex,!0)}#u(t,i){this.#t?.updateSettings({streaming:{abr:{autoSwitchBitrate:{[t]:i}}}})}#D(){const{qualities:t}=this.#i;!this.#t||t.auto||!t.selected||(this.#u("video",!1),this.#t.setQualityFor("video",t.selectedIndex,t.switch==="current"),_&&(this.#e.currentTime=this.#e.currentTime))}#x(){if(!this.#t)return;const{audioTracks:t}=this.#i,i=this.#t.getTracksFor("audio").find(s=>t.selected&&t.selected.id===`dash-audio-${s.index}`);i&&this.#t.setCurrentTrack(i)}#p(){this.#c(),this.#a=null,this.#h={}}onInstance(t){return this.#n.add(t),()=>this.#n.delete(t)}loadSource(t){this.#p(),p(t.src)&&this.#t?.attachSource(t.src)}destroy(){this.#p(),this.#t?.destroy(),this.#t=null,this.#r?.(),this.#r=null}}class V{#e;#i;#t;constructor(t,i,s){this.#e=t,this.#i=i,this.#t=s,this.#n()}async#n(){const t={onLoadStart:this.#r.bind(this),onLoaded:this.#s.bind(this),onLoadError:this.#d.bind(this)};let i=await U(this.#e,t);if(E(i)&&!p(this.#e)&&(i=await K(this.#e,t)),!i)return null;if(!window.dashjs.supportsMediaSource()){const s="[vidstack] `dash.js` is not supported in this environment";return this.#i.player.dispatch(new l("dash-unsupported")),this.#i.notify("error",{message:s,code:4}),null}return i}#r(){this.#i.player.dispatch(new l("dash-lib-load-start"))}#s(t){this.#i.player.dispatch(new l("dash-lib-loaded",{detail:t})),this.#t(t)}#d(t){const i=$(t);this.#i.player.dispatch(new l("dash-lib-load-error",{detail:i})),this.#i.notify("error",{message:i.message,code:4,error:i})}}async function K(a,t={}){if(!E(a)){if(t.onLoadStart?.(),B(a))return t.onLoaded?.(a),a;if(w(a)){const i=a.MediaPlayer;return t.onLoaded?.(i),i}try{const i=(await a())?.default;if(w(i))return t.onLoaded?.(i.MediaPlayer),i.MediaPlayer;if(i)t.onLoaded?.(i);else throw Error("");return i}catch(i){t.onLoadError?.(i)}}}async function U(a,t={}){if(p(a)){t.onLoadStart?.();try{if(await q(a),!H(window.dashjs.MediaPlayer))throw Error("");const i=window.dashjs.MediaPlayer;return t.onLoaded?.(i),i}catch(i){t.onLoadError?.(i)}}}function B(a){return a&&a.prototype&&a.prototype!==Function}function w(a){return a&&"MediaPlayer"in a}const z="https://cdn.jsdelivr.net";class tt extends O{$$PROVIDER_TYPE="DASH";#e=null;#i=new G(this.video,this.ctx);get ctor(){return this.#e}get instance(){return this.#i.instance}static supported=x();get type(){return"dash"}get canLiveSync(){return!0}#t=`${z}/npm/dashjs@4.7.4/dist/dash.all.min.js`;get config(){return this.#i.config}set config(t){this.#i.config=t}get library(){return this.#t}set library(t){this.#t=t}preconnect(){p(this.#t)&&k(this.#t)}setup(){super.setup(),new V(this.#t,this.ctx,t=>{this.#e=t,this.#i.setup(t),this.ctx.notify("provider-setup",this);const i=M(this.ctx.$state.source);i&&this.loadSource(i)})}async loadSource(t,i){if(!p(t.src)){this.removeSource();return}this.media.preload=i||"",this.appendSource(t,"application/x-mpegurl"),this.#i.loadSource(t),this.currentSrc=t}onInstance(t){const i=this.#i.instance;return i&&t(i),this.#i.onInstance(t)}destroy(){this.#i.destroy()}}export{tt as DASHProvider};
